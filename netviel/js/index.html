<!DOCTYPE html>
<meta charset="utf-8">
<style>
* {
	box-sizing: border-box;
}

body {
	font-size: 11pt;
}

input {
	width: 100%;
}

table {
	border-collapse: collapse;
}
tr:nth-child(2n+1) {
	background-color: #eee;
}
td {
	vertical-align: top;
}
td:not(:last-child) {
	padding-right: .75ex;
}
td.subject {
	min-width: 60%;
}

.message {
	border-top: 1px dashed #aaa;
	margin-top: 1em;
	padding-top: .3ex;
}

.message .meta {
	margin-bottom: 1ex;
}

.message .subject {
	font-size: large;
	font-weight: bold;
}
.message .date {
	float: right;
}

.message .content.plain {
	white-space: pre-wrap;
	font-family: monospace;
}

iframe {
	border: none;
	width: 100%;
	/* if initial iframe is taller than its content, it won't shrink, hence 5px */
	height: 5px;
}
</style>
<body><div id="vue">
	<div v-show="!thread">
	<input v-model="query" ref="query" @keyup.enter="search">
	<table>
		<tr v-for="res in results" :key="res.thread_id" @click="fetch_thread(res.thread_id)">
			<td>{{ res.authors }}</td>
			<td class="subject">{{ res.subject }}</td>
			<td>{{ res.tags }}</td>
			<td>{{ res.matched_messages }}/{{ res.total_messages }}</td>
			<td>{{ res.oldest_date }} â€“ {{ res.newest_date }}</td>
		</tr>
	</table>
	</div>

	<template v-if="thread">
		<message v-for="m in thread" v-bind="m"></message>
	</template>
</div></body>
<script src="vue-2.6.11.js"></script>
<script>
Vue.component('message', {
	props: 'date subject from to cc bcc content_type content attachments message_id'.split(' '),
	computed: {
		isHTML: function() {
			return this.content_type == 'text/html'
		},
	},
	methods: {
		resize: function() {
			let c = this.$refs.content;
			c.style.height = c.contentWindow.document.documentElement.scrollHeight + 'px';
		}
	},
	template: `
		<div class="message">
			<div class="meta">
				<span class="date">{{date}}</span>
				<span class="subject">{{subject}}</span>
				<template v-if="from">
					<br>
					From: {{from}}
				</template>
				<template v-if="to">
					<br>
					To: {{to}}
				</template>
				<template v-if="cc">
					<br>
					CC: {{cc}}
				</template>
				<template v-if="bcc">
					<br>
					BCC: {{bcc}}
				</template>
			</div>
			<iframe v-if="isHTML" class="content" @load="resize" ref="content" sandbox='allow-same-origin' :srcdoc="content"></iframe>
			<div v-else class="content plain">{{content}}</div>
			<br>
			<!-- TODO attachments -->
		</div>
	`,
});

var app = new Vue({
	el: '#vue',
	data: {
		query: '',
		results: [],
		thread: null,
	},
	mounted: function() {
		Vue.nextTick(() => {
			this.$refs.query.focus();
		});
	},
	methods: {
		search: function() {
			let self = this;
			fetch('/api/query/' + encodeURIComponent(this.query))
			.catch(function(err) {
				console.error(err);
				// TODO
			})
			.then((resp) => resp.json())
			.then(function(data) {
				self.results = data;
			});
		},
		fetch_thread: function(id) {
			let self = this;
			fetch('/api/thread/' + encodeURIComponent(id))
			.catch(function(err) {
				console.error(err);
				// TODO
			})
			.then((resp) => resp.json())
			.then(function(data) {
				self.thread = data;
			});

		}
	},
})
</script>
